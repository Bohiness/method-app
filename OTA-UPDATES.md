# Обновления по воздуху (OTA) с EAS Update

Эта инструкция описывает, как использовать обновления по воздуху для приложения Method, чтобы не требовалось выпускать новые версии через App Store или Google Play.

## Настройка проекта

Настройка для OTA-обновлений выполнена:

1. Установлен пакет `expo-updates` ✅
2. Создан сервис для управления обновлениями `src/shared/lib/update/update.service.ts` ✅
3. Настроен `app.config.js`:
    - В секции `updates` включены автоматические проверки обновлений и указан URL ✅
    - Настроен `runtimeVersion` с политикой `appVersion` ✅
    - Указан канал для обновлений `production` ✅
4. Настроен `eas.json` с каналами для разных сред ✅

## Система обновлений

Система обновлений включает два типа проверок:

1. **OTA-обновления** - для обновления JavaScript кода и ресурсов без публикации новой версии в сторах
2. **Проверка наличия новых версий в App Store/Google Play** - для уведомления пользователей о необходимости обновления через сторы

## Использование

### Выпуск обновлений для продакшн

Для выпуска обновления для продакшн-версии приложения:

```bash
npm run update "Описание обновления"
```

или напрямую через EAS CLI:

```bash
npx eas update --branch production --message "Описание обновления"
```

Например:

```bash
npx eas update --branch production --message "Исправлены ошибки в модуле планирования"
```

### Выпуск обновлений для разработки/тестирования

Для выпуска обновления для тестовой версии приложения:

```bash
npm run update:dev "Описание обновления"
```

или напрямую через EAS CLI:

```bash
npx eas update --branch development --message "Описание обновления"
```

## Как это работает

### OTA-обновления

1. При запуске приложения, в `_layout.tsx` вызывается `updateService.checkForUpdates()`
2. Если доступно обновление, оно загружается и пользователю показывается диалог
3. После подтверждения пользователем приложение перезагружается с новым кодом
4. Приложение также проверяет обновления при возвращении из фона

### Проверка обновлений в сторах

1. Если OTA-обновлений не найдено или произошла ошибка, система проверяет наличие новой версии в App Store/Google Play
2. Проверка в сторах выполняется не чаще одного раза в день
3. Если найдена новая версия, пользователю показывается диалог с предложением обновиться
4. При нажатии "Обновить" пользователь перенаправляется на страницу приложения в соответствующем сторе

## Мониторинг и управление обновлениями

Все опубликованные обновления доступны для просмотра и управления в EAS Dashboard: [EAS Dashboard](https://expo.dev/accounts/bohiness/projects/method-app/updates)

## Важные замечания

1. Обновления по воздуху работают только для изменений JavaScript/TypeScript кода, изображений и других ресурсов
2. Если вы меняете нативный код, добавляете новые зависимости, требующие нативной линковки, или меняете конфигурацию, вам всё равно потребуется выпустить новую версию через App Store/Google Play
3. Перед выпуском важных обновлений, рекомендуется проверить их в development-ветке

## Ограничения

-   OTA-обновления не работают для изменений в `app.config.js` или `app.json`
-   Они не работают для изменений в нативном коде (Swift/Objective-C/Java/Kotlin)
-   Не работают для обновления версии Expo SDK, React Native или других библиотек с нативным кодом

## Создание новых сборок

При создании новых сборок для публикации в App Store или Google Play:

```bash
eas build --platform ios --profile production
eas build --platform android --profile production
```

После создания новых сборок с изменённым нативным кодом, вы можете продолжать выпускать OTA-обновления для этих версий.

## Дополнительная информация

Для более подробной информации посетите:

-   [Официальная документация Expo Updates](https://docs.expo.dev/eas-update/introduction/)
-   [Руководство по EAS Update](https://docs.expo.dev/eas-update/getting-started/)
